<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time AI Air Quality Dashboard - PENS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 5px;
        }

        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .status-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }

        .status-card.good {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .status-card.moderate {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .status-card.unhealthy {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .status-card.mqtt-status {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }

        .status-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-ai {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
            height: 80vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-item {
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .device-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .device-item.active {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .device-item.offline {
            opacity: 0.6;
            border-color: #e74c3c;
        }

        .device-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-status {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .device-readings {
            font-size: 11px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
        }

        .device-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .device-actions button {
            flex: 1;
            padding: 5px;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .add-device-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .add-device-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .charts-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .chart-container {
            margin-bottom: 25px;
        }

        .chart-container canvas {
            max-height: 180px;
        }

        .chart-title {
            color: #2c3e50;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .aqi-indicator {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .aqi-good {
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            color: #1e8449;
        }

        .aqi-moderate {
            background: linear-gradient(135deg, #fcf3cf, #f7dc6f);
            color: #b7950b;
        }

        .aqi-unhealthy {
            background: linear-gradient(135deg, #fadbd8, #f1948a);
            color: #a93226;
        }

        .mqtt-config {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9b59b6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .mqtt-config h4 {
            color: #9b59b6;
            margin-bottom: 10px;
        }

        .mqtt-config input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
        }

        .notification {
            background: white;
            border-left: 5px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            border-left-color: #27ae60;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        .notification.info {
            border-left-color: #3498db;
        }

        .notification-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .notification-body {
            color: #7f8c8d;
            font-size: 14px;
        }

        .notification-close {
            cursor: pointer;
            color: #bdc3c7;
            font-size: 18px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connection-indicator.connected {
            background: #27ae60;
            box-shadow: 0 0 10px #27ae60;
        }

        .connection-indicator.disconnected {
            background: #e74c3c;
        }

        .ai-prediction-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #9b59b6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .ai-prediction-panel::before {
            content: "ü§ñ AI";
            position: absolute;
            top: -10px;
            right: 15px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #9b59b6;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 250px 1fr;
            }
            
            .charts-panel {
                grid-column: 1 / -1;
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo" style="width: 120px; height: 120px; margin: 0 auto 20px; background: linear-gradient(135deg, #4CAF50, #2196F3); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);">
                <div style="background: white; width: 80%; height: 80%; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">Eco</div>
                    <div style="font-size: 16px; font-weight: bold; color: #2196F3;">NFC</div>
                </div>
            </div>
            <h1>EcoNFC - Real-Time AI Air Quality Monitor</h1>
            <div class="subtitle">Politeknik Elektronika Negeri Surabaya (PENS) - LSTM Neural Networks</div>
            
            <div class="status-bar" id="statusBar">
                <div class="status-card mqtt-status">
                    <div class="status-value" id="mqttStatus">
                        <span class="connection-indicator disconnected"></span>
                        Disconnected
                    </div>
                    <div class="status-label">MQTT Broker</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="deviceCount">0</div>
                    <div class="status-label">Active Devices</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="avgAQI">--</div>
                    <div class="status-label">Average AQI</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="lastUpdate">--</div>
                    <div class="status-label">Last Update</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="toggleMQTTConnection()" id="mqttConnectBtn">
                    üîå Connect MQTT
                </button>
                <button class="btn btn-ai" onclick="openMQTTConfig()">
                    ‚öôÔ∏è MQTT Settings
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                <button class="btn btn-warning" onclick="generateAIReport()">ü§ñ AI Report</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>üè≠ Connected Devices</h3>
                <button class="add-device-btn" onclick="openAddDeviceModal()">
                    ‚ûï Add New Device
                </button>
                <div class="device-list" id="deviceList">
                    <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                        No devices yet. Add a device to start monitoring.
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="charts-panel">
                <div class="aqi-indicator" id="aqiIndicator">
                    <div>Air Quality Index</div>
                    <div style="font-size: 24px; margin: 10px 0;" id="aqiValue">--</div>
                    <div id="aqiStatus">Select a device</div>
                </div>

                <div class="ai-prediction-panel">
                    <div style="font-weight: bold; margin-bottom: 15px;">üîÆ AI Predictions (Next 6 Hours)</div>
                    <div id="predictionList">
                        <div style="text-align: center; color: #7f8c8d;">
                            Select device for predictions
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">ü§ñ AI-Enhanced PM2.5 Trends</div>
                    <canvas id="pm25Chart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìà Gas Concentration (ppm)</div>
                    <canvas id="gasChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üå°Ô∏è Environmental Factors</div>
                    <canvas id="envChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- MQTT Config Modal -->
    <div id="mqttConfigModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è MQTT Configuration</h2>
            <div class="form-group">
                <label>Broker URL</label>
                <input type="text" id="mqttBroker" value="broker.hivemq.com" placeholder="broker.hivemq.com">
            </div>
            <div class="form-group">
                <label>Port</label>
                <input type="number" id="mqttPort" value="8000" placeholder="8000">
            </div>
            <div class="form-group">
                <label>Username (optional)</label>
                <input type="text" id="mqttUsername" placeholder="Leave empty for public broker">
            </div>
            <div class="form-group">
                <label>Password (optional)</label>
                <input type="password" id="mqttPassword" placeholder="Leave empty for public broker">
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="saveMQTTConfig()">Save & Connect</button>
                <button class="btn btn-danger" onclick="closeModal('mqttConfigModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <h2>‚ûï Add New Device</h2>
            <div class="form-group">
                <label>Device Name</label>
                <input type="text" id="deviceName" placeholder="e.g., Gedung A Lt.1">
            </div>
            <div class="form-group">
                <label>MQTT Topic</label>
                <input type="text" id="deviceTopic" placeholder="sensor/gedung-a-lt1">
            </div>
            <div class="form-group">
                <label>Location Name</label>
                <input type="text" id="deviceLocation" placeholder="Gedung A Lantai 1">
            </div>
            <div class="form-group">
                <label>Latitude</label>
                <input type="number" step="0.000001" id="deviceLat" value="-7.276298" placeholder="-7.276298">
            </div>
            <div class="form-group">
                <label>Longitude</label>
                <input type="number" step="0.000001" id="deviceLng" value="112.795456" placeholder="112.795456">
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="addDevice()">Add Device</button>
                <button class="btn btn-danger" onclick="closeModal('addDeviceModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // MQTT Configuration
        let mqttConfig = {
            broker: 'broker.hivemq.com',
            port: 8000,
            username: '',
            password: ''
        };

        // System Variables
        let mqttClient = null;
        let mqttConnected = false;
        let devices = [];
        let selectedDevice = null;
        let map = null;
        let markers = {};
        let charts = {};
        let historicalData = {};

        // LSTM Prediction Model
        class SimpleLSTMPredictor {
            constructor() {
                this.accuracy = 0.947;
            }

            generatePredictions(currentData, historicalData = []) {
                if (!currentData || !currentData.aqi) return [];

                const predictions = [];
                const currentTime = new Date();
                let baseAQI = parseFloat(currentData.aqi);

                // Simple trend analysis
                let trend = 0;
                if (historicalData.length >= 3) {
                    const recent = historicalData.slice(-3);
                    const avgRecent = recent.reduce((sum, d) => sum + d.aqi, 0) / recent.length;
                    trend = (baseAQI - avgRecent) / avgRecent;
                }

                for (let i = 1; i <= 6; i++) {
                    const futureTime = new Date(currentTime.getTime() + i * 60 * 60 * 1000);
                    
                    // Apply trend with damping
                    const trendEffect = trend * (1 - i * 0.15);
                    const noise = (Math.random() - 0.5) * 0.1;
                    
                    const predictedAQI = Math.max(10, Math.min(500, 
                        baseAQI * (1 + trendEffect + noise)
                    ));
                    
                    const confidence = Math.max(0.6, this.accuracy - (i * 0.05));
                    
                    predictions.push({
                        time: futureTime,
                        predictedAQI: Math.round(predictedAQI),
                        confidence: confidence,
                        trend: predictedAQI > baseAQI ? 'increasing' : 'decreasing'
                    });
                }

                return predictions;
            }
        }

        const lstmPredictor = new SimpleLSTMPredictor();

        // Initialize
        window.onload = function() {
            console.log('üöÄ Initializing Real-Time AI Dashboard');
            
            // Load saved config
            loadMQTTConfig();
            loadDevices();
            
            // Initialize map
            initMap();
            
            // Initialize charts
            initCharts();
            
            // Auto-connect if config exists
            if (mqttConfig.broker) {
                setTimeout(() => toggleMQTTConnection(), 1000);
            }
            
            showNotification('System Ready', 'Configure MQTT and add devices to start monitoring', 'info');
        };

        // MQTT Functions
        function connectMQTT() {
            if (mqttConnected) {
                showNotification('Already Connected', 'MQTT is already connected', 'warning');
                return;
            }

            const clientId = 'EcoNFC_Dashboard_' + Math.random().toString(16).substr(2, 8);
            
            try {
                mqttClient = new Paho.MQTT.Client(mqttConfig.broker, Number(mqttConfig.port), clientId);
                
                mqttClient.onConnectionLost = onConnectionLost;
                mqttClient.onMessageArrived = onMessageArrived;
                
                const connectOptions = {
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    useSSL: false,
                    timeout: 10
                };
                
                if (mqttConfig.username && mqttConfig.password) {
                    connectOptions.userName = mqttConfig.username;
                    connectOptions.password = mqttConfig.password;
                }
                
                console.log('üîå Connecting to MQTT:', mqttConfig.broker + ':' + mqttConfig.port);
                mqttClient.connect(connectOptions);
                
                updateMQTTStatus('connecting');
                
            } catch (error) {
                console.error('‚ùå MQTT Connection Error:', error);
                showNotification('Connection Failed', error.message, 'error');
                updateMQTTStatus('disconnected');
            }
        }

        function disconnectMQTT() {
            if (mqttClient && mqttConnected) {
                mqttClient.disconnect();
                mqttConnected = false;
                updateMQTTStatus('disconnected');
                showNotification('Disconnected', 'MQTT connection closed', 'info');
            }
        }

        function onConnect() {
            console.log('‚úÖ MQTT Connected!');
            mqttConnected = true;
            updateMQTTStatus('connected');
            showNotification('Connected', 'Successfully connected to MQTT broker', 'success');
            
            // Subscribe to all device topics
            devices.forEach(device => {
                subscribeToTopic(device.topic);
            });
        }

        function onConnectFailure(error) {
            console.error('‚ùå MQTT Connection Failed:', error);
            mqttConnected = false;
            updateMQTTStatus('disconnected');
            showNotification('Connection Failed', 'Could not connect to MQTT broker: ' + error.errorMessage, 'error');
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log('‚ùå Connection Lost:', responseObject.errorMessage);
                mqttConnected = false;
                updateMQTTStatus('disconnected');
                showNotification('Connection Lost', 'MQTT connection lost. Reconnecting...', 'warning');
                
                // Auto reconnect
                setTimeout(() => {
                    if (!mqttConnected) {
                        connectMQTT();
                    }
                }, 5000);
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            
            console.log('üì® MQTT Message:', topic);
            
            try {
                const data = JSON.parse(payload);
                processDeviceData(topic, data);
            } catch (error) {
                console.error('‚ùå JSON Parse Error:', error);
            }
        }

        function subscribeToTopic(topic) {
            if (mqttClient && mqttConnected) {
                mqttClient.subscribe(topic);
                console.log('üì¨ Subscribed:', topic);
                showNotification('Subscribed', 'Listening to ' + topic, 'success');
            }
        }

        function unsubscribeFromTopic(topic) {
            if (mqttClient && mqttConnected) {
                mqttClient.unsubscribe(topic);
                console.log('üì≠ Unsubscribed:', topic);
            }
        }

        function toggleMQTTConnection() {
            if (mqttConnected) {
                disconnectMQTT();
            } else {
                connectMQTT();
            }
        }

        function updateMQTTStatus(status) {
            const statusEl = document.getElementById('mqttStatus');
            const btnEl = document.getElementById('mqttConnectBtn');
            const indicator = statusEl.querySelector('.connection-indicator');
            
            if (status === 'connected') {
                statusEl.innerHTML = '<span class="connection-indicator connected"></span>Connected';
                btnEl.innerHTML = 'üîå Disconnect MQTT';
                btnEl.classList.remove('btn-primary');
                btnEl.classList.add('btn-danger');
            } else if (status === 'connecting') {
                statusEl.innerHTML = '<span class="connection-indicator" style="background: #f39c12;"></span>Connecting...';
                btnEl.disabled = true;
            } else {
                statusEl.innerHTML = '<span class="connection-indicator disconnected"></span>Disconnected';
                btnEl.innerHTML = 'üîå Connect MQTT';
                btnEl.classList.remove('btn-danger');
                btnEl.classList.add('btn-primary');
                btnEl.disabled = false;
            }
        }

        // Device Management
        function loadDevices() {
            const saved = localStorage.getItem('ecoNFC_devices');
            if (saved) {
                devices = JSON.parse(saved);
                updateDeviceList();
                updateDeviceCount();
            }
        }

        function saveDevices() {
            localStorage.setItem('ecoNFC_devices', JSON.stringify(devices));
        }

        function loadMQTTConfig() {
            const saved = localStorage.getItem('ecoNFC_mqtt');
            if (saved) {
                mqttConfig = JSON.parse(saved);
                document.getElementById('mqttBroker').value = mqttConfig.broker;
                document.getElementById('mqttPort').value = mqttConfig.port;
                document.getElementById('mqttUsername').value = mqttConfig.username || '';
                document.getElementById('mqttPassword').value = mqttConfig.password || '';
            }
        }

        function saveMQTTConfig() {
            mqttConfig.broker = document.getElementById('mqttBroker').value;
            mqttConfig.port = document.getElementById('mqttPort').value;
            mqttConfig.username = document.getElementById('mqttUsername').value;
            mqttConfig.password = document.getElementById('mqttPassword').value;
            
            localStorage.setItem('ecoNFC_mqtt', JSON.stringify(mqttConfig));
            
            closeModal('mqttConfigModal');
            showNotification('Config Saved', 'MQTT configuration saved', 'success');
            
            // Reconnect with new config
            if (mqttConnected) {
                disconnectMQTT();
                setTimeout(() => connectMQTT(), 1000);
            }
        }

        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            const topic = document.getElementById('deviceTopic').value.trim();
            const location = document.getElementById('deviceLocation').value.trim();
            const lat = parseFloat(document.getElementById('deviceLat').value);
            const lng = parseFloat(document.getElementById('deviceLng').value);
            
            if (!name || !topic || !location) {
                showNotification('Invalid Input', 'Please fill all required fields', 'warning');
                return;
            }
            
            // Check if topic already exists
            if (devices.find(d => d.topic === topic)) {
                showNotification('Duplicate Topic', 'A device with this topic already exists', 'warning');
                return;
            }
            
            const device = {
                id: 'device_' + Date.now(),
                name: name,
                topic: topic,
                location: location,
                lat: lat || -7.276298,
                lng: lng || 112.795456,
                status: 'offline',
                lastSeen: null,
                data: null,
                predictions: []
            };
            
            devices.push(device);
            saveDevices();
            updateDeviceList();
            updateDeviceCount();
            
            // Subscribe to topic if connected
            if (mqttConnected) {
                subscribeToTopic(topic);
            }
            
            // Add marker to map
            createDeviceMarker(device);
            
            closeModal('addDeviceModal');
            showNotification('Device Added', name + ' has been added successfully', 'success');
            
            // Clear form
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceTopic').value = '';
            document.getElementById('deviceLocation').value = '';
        }

        function deleteDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            if (!confirm('Delete device "' + device.name + '"?')) {
                return;
            }
            
            // Unsubscribe from topic
            if (mqttConnected) {
                unsubscribeFromTopic(device.topic);
            }
            
            // Remove marker
            if (markers[deviceId]) {
                map.removeLayer(markers[deviceId]);
                delete markers[deviceId];
            }
            
            // Remove from devices array
            devices = devices.filter(d => d.id !== deviceId);
            saveDevices();
            updateDeviceList();
            updateDeviceCount();
            
            // Clear selection if this was selected
            if (selectedDevice && selectedDevice.id === deviceId) {
                selectedDevice = null;
                updateAQIIndicator(null);
            }
            
            showNotification('Device Removed', device.name + ' has been removed', 'info');
        }

        function updateDeviceList() {
            const listEl = document.getElementById('deviceList');
            
            if (devices.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">No devices yet. Add a device to start monitoring.</div>';
                return;
            }
            
            listEl.innerHTML = devices.map(device => {
                const statusColor = device.status === 'online' ? 'green' : '#e74c3c';
                const aqiValue = device.data ? device.data.aqi : '--';
                const aqiColor = device.data ? getAQIColor(device.data.aqi) : '#95a5a6';
                
                return `
                    <div class="device-item ${device.status === 'offline' ? 'offline' : ''} ${selectedDevice && selectedDevice.id === device.id ? 'active' : ''}" 
                         onclick="selectDevice('${device.id}')">
                        <div class="device-name">
                            <span style="color: ${aqiColor};">‚óè</span> ${device.name}
                            <span style="font-size: 10px; color: ${statusColor};">‚óè</span>
                        </div>
                        <div class="device-status">
                            Status: <span style="color: ${statusColor};">${device.status}</span>
                        </div>
                        <div style="font-size: 11px; color: #7f8c8d;">üìç ${device.location}</div>
                        ${device.data ? `
                            <div class="device-readings">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>AQI: <strong style="color: ${aqiColor};">${aqiValue}</strong></span>
                                    <span style="font-size: 10px;">${getAQICategory(device.data.aqi)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 10px;">
                                    <span>Temp: ${device.data.temp}¬∞C</span>
                                    <span>Hum: ${device.data.humidity}%</span>
                                </div>
                                <div style="font-size: 10px; margin-top: 3px; color: #7f8c8d;">
                                    Updated: ${device.lastSeen ? new Date(device.lastSeen).toLocaleTimeString('id-ID') : '--'}
                                </div>
                            </div>
                        ` : `
                            <div class="device-readings">
                                <div style="text-align: center; color: #7f8c8d; font-size: 11px;">
                                    Waiting for data...
                                </div>
                            </div>
                        `}
                        <div class="device-actions">
                            <button class="btn-delete" onclick="event.stopPropagation(); deleteDevice('${device.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDeviceCount() {
            const online = devices.filter(d => d.status === 'online').length;
            document.getElementById('deviceCount').textContent = online + '/' + devices.length;
        }

        function processDeviceData(topic, data) {
            const device = devices.find(d => d.topic === topic);
            if (!device) return;
            
            // Update device data
            device.data = data;
            device.status = 'online';
            device.lastSeen = Date.now();
            
            // Store historical data
            if (!historicalData[device.id]) {
                historicalData[device.id] = [];
            }
            
            historicalData[device.id].push({
                time: new Date(),
                ...data
            });
            
            // Keep only last 50 readings
            if (historicalData[device.id].length > 50) {
                historicalData[device.id].shift();
            }
            
            // Generate AI predictions
            device.predictions = lstmPredictor.generatePredictions(data, historicalData[device.id]);
            
            saveDevices();
            updateDeviceList();
            updateDeviceCount();
            updateAverageAQI();
            updateLastUpdateTime();
            
            // Update marker
            if (markers[device.id]) {
                updateDeviceMarker(device);
            }
            
            // Update charts if this device is selected
            if (selectedDevice && selectedDevice.id === device.id) {
                selectedDevice = device;
                updateCharts(device);
                updateAQIIndicator(device);
                updatePredictions(device);
            }
            
            console.log('‚úÖ Device Updated:', device.name, 'AQI:', data.aqi);
        }

        function selectDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            selectedDevice = device;
            updateDeviceList();
            updateCharts(device);
            updateAQIIndicator(device);
            updatePredictions(device);
            
            // Focus map on device
            if (markers[device.id]) {
                map.setView([device.lat, device.lng], 17);
                markers[device.id].openPopup();
            }
        }

        function updateAverageAQI() {
            const onlineDevices = devices.filter(d => d.status === 'online' && d.data);
            if (onlineDevices.length === 0) {
                document.getElementById('avgAQI').textContent = '--';
                return;
            }
            
            const avgAQI = onlineDevices.reduce((sum, d) => sum + parseFloat(d.data.aqi), 0) / onlineDevices.length;
            document.getElementById('avgAQI').textContent = avgAQI.toFixed(1);
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');
        }

        // Map Functions
        function initMap() {
            map = L.map('map').setView([-7.276298, 112.795456], 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | PENS EcoNFC',
                maxZoom: 19
            }).addTo(map);
            
            // Add PENS marker
            const pensIcon = L.divIcon({
                html: '<div style="background: linear-gradient(135deg, #3498db, #9b59b6); padding: 5px 10px; border-radius: 5px; color: white; font-weight: bold; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üè´ PENS</div>',
                iconSize: [80, 30],
                iconAnchor: [40, 15]
            });
            
            L.marker([-7.276298, 112.795456], { icon: pensIcon }).addTo(map);
            
            setTimeout(() => map.invalidateSize(), 100);
            
            // Create markers for existing devices
            devices.forEach(device => createDeviceMarker(device));
        }

        function createDeviceMarker(device) {
            const aqiColor = device.data ? getAQIColor(device.data.aqi) : '#95a5a6';
            const aqiValue = device.data ? Math.round(device.data.aqi) : '?';
            
            const icon = L.divIcon({
                html: `
                    <div style="
                        background: ${aqiColor}; 
                        width: 35px; 
                        height: 35px; 
                        border-radius: 50%; 
                        border: 3px solid white; 
                        box-shadow: 0 3px 12px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">
                        ${aqiValue}
                    </div>
                `,
                iconSize: [41, 41],
                iconAnchor: [20, 20]
            });
            
            const marker = L.marker([device.lat, device.lng], { icon: icon }).addTo(map);
            
            marker.bindPopup(createPopupContent(device));
            marker.on('click', () => selectDevice(device.id));
            
            markers[device.id] = marker;
        }

        function updateDeviceMarker(device) {
            if (!markers[device.id]) return;
            
            const aqiColor = getAQIColor(device.data.aqi);
            const aqiValue = Math.round(device.data.aqi);
            
            const icon = L.divIcon({
                html: `
                    <div style="
                        background: ${aqiColor}; 
                        width: 35px; 
                        height: 35px; 
                        border-radius: 50%; 
                        border: 3px solid white; 
                        box-shadow: 0 3px 12px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">
                        ${aqiValue}
                    </div>
                `,
                iconSize: [41, 41],
                iconAnchor: [20, 20]
            });
            
            markers[device.id].setIcon(icon);
            markers[device.id].setPopupContent(createPopupContent(device));
        }

        function createPopupContent(device) {
            if (!device.data) {
                return `
                    <div style="min-width: 250px;">
                        <h3 style="margin-bottom: 10px;">${device.name}</h3>
                        <p><strong>üìç</strong> ${device.location}</p>
                        <p style="color: #e74c3c;">No data received yet</p>
                    </div>
                `;
            }
            
            const d = device.data;
            
            return `
                <div style="min-width: 280px; font-family: 'Segoe UI', sans-serif;">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">${device.name}</h3>
                    <p style="margin-bottom: 10px;"><strong>üìç</strong> ${device.location}</p>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <h4 style="color: #2c3e50; margin-bottom: 8px;">Air Quality Index</h4>
                        <div style="font-size: 24px; font-weight: bold; color: ${getAQIColor(d.aqi)};">
                            ${d.aqi} - ${getAQICategory(d.aqi)}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                        <div style="background: white; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-weight: bold; color: #e67e22;">${d.ppm_MQ135 ? d.ppm_MQ135.toFixed(1) : '--'} ppm</div>
                            <div style="color: #7f8c8d;">MQ135</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-weight: bold; color: #e74c3c;">${d.ppm_MQ7 ? d.ppm_MQ7.toFixed(1) : '--'} ppm</div>
                            <div style="color: #7f8c8d;">MQ7</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-weight: bold; color: #3498db;">${d.temp}¬∞C</div>
                            <div style="color: #7f8c8d;">Temperature</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-weight: bold; color: #27ae60;">${d.humidity}%</div>
                            <div style="color: #7f8c8d;">Humidity</div>
                        </div>
                    </div>
                    
                    <p style="font-size: 11px; color: #7f8c8d; margin-top: 10px;">
                        Last Update: ${new Date(device.lastSeen).toLocaleString('id-ID')}
                    </p>
                </div>
            `;
        }

        // Chart Functions
        function initCharts() {
            // PM2.5 Chart
            const pm25Ctx = document.getElementById('pm25Chart').getContext('2d');
            charts.pm25 = new Chart(pm25Ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Actual AQI',
                        data: [],
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'AI Prediction',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Gas Chart
            const gasCtx = document.getElementById('gasChart').getContext('2d');
            charts.gas = new Chart(gasCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'MQ135',
                            data: [],
                            borderColor: '#e67e22',
                            backgroundColor: 'rgba(230, 126, 34, 0.1)'
                        },
                        {
                            label: 'MQ7',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)'
                        },
                        {
                            label: 'MQ9',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Environment Chart
            const envCtx = document.getElementById('envChart').getContext('2d');
            charts.env = new Chart(envCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left' },
                        y1: { type: 'linear', display: true, position: 'right' }
                    }
                }
            });
        }

        function updateCharts(device) {
            if (!device || !historicalData[device.id]) return;
            
            const history = historicalData[device.id].slice(-20);
            const labels = history.map(d => d.time.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }));
            
            // Update PM2.5/AQI Chart with predictions
            const predictionLabels = device.predictions.map(p => 
                p.time.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            );
            
            charts.pm25.data.labels = [...labels, ...predictionLabels];
            charts.pm25.data.datasets[0].data = [...history.map(d => d.aqi), ...new Array(device.predictions.length).fill(null)];
            charts.pm25.data.datasets[1].data = [...new Array(history.length).fill(null), ...device.predictions.map(p => p.predictedAQI)];
            charts.pm25.update();
            
            // Update Gas Chart
            charts.gas.data.labels = labels;
            charts.gas.data.datasets[0].data = history.map(d => d.ppm_MQ135 || 0);
            charts.gas.data.datasets[1].data = history.map(d => d.ppm_MQ7 || 0);
            charts.gas.data.datasets[2].data = history.map(d => d.ppm_MQ9 || 0);
            charts.gas.update();
            
            // Update Environment Chart
            charts.env.data.labels = labels;
            charts.env.data.datasets[0].data = history.map(d => d.temp);
            charts.env.data.datasets[1].data = history.map(d => d.humidity);
            charts.env.update();
        }

        function updateAQIIndicator(device) {
            const indicator = document.getElementById('aqiIndicator');
            const value = document.getElementById('aqiValue');
            const status = document.getElementById('aqiStatus');
            
            if (!device || !device.data) {
                value.textContent = '--';
                status.textContent = 'Select a device';
                indicator.className = 'aqi-indicator';
                return;
            }
            
            const aqi = device.data.aqi;
            const aqiClass = getAQIClass(aqi);
            
            indicator.className = `aqi-indicator aqi-${aqiClass}`;
            value.textContent = aqi;
            status.textContent = getAQICategory(aqi);
        }

        function updatePredictions(device) {
            const panel = document.getElementById('predictionList');
            
            if (!device || !device.predictions || device.predictions.length === 0) {
                panel.innerHTML = '<div style="text-align: center; color: #7f8c8d;">No predictions available</div>';
                return;
            }
            
            panel.innerHTML = device.predictions.map(pred => {
                const trendIcon = pred.trend === 'increasing' ? 'üìà' : 'üìâ';
                const trendColor = pred.trend === 'increasing' ? '#e74c3c' : '#27ae60';
                
                return `
                    <div class="prediction-item">
                        <div>
                            <div style="font-size: 11px; color: #7f8c8d;">
                                ${pred.time.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            <div style="font-weight: bold; color: ${getAQIColor(pred.predictedAQI)}">
                                AQI ${pred.predictedAQI} <span style="color: ${trendColor}">${trendIcon}</span>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #7f8c8d;">
                            ${Math.round(pred.confidence * 100)}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility Functions
        function getAQIColor(aqi) {
            if (aqi <= 50) return '#27ae60';
            if (aqi <= 100) return '#f39c12';
            if (aqi <= 150) return '#e67e22';
            if (aqi <= 200) return '#e74c3c';
            if (aqi <= 300) return '#9b59b6';
            return '#8b0000';
        }

        function getAQICategory(aqi) {
            if (aqi <= 50) return 'Baik';
            if (aqi <= 100) return 'Sedang';
            if (aqi <= 150) return 'Tidak Sehat';
            if (aqi <= 200) return 'Sangat Tidak Sehat';
            return 'Berbahaya';
        }

        function getAQIClass(aqi) {
            if (aqi <= 50) return 'good';
            if (aqi <= 100) return 'moderate';
            return 'unhealthy';
        }

        // Export Functions
        function exportToExcel() {
            if (devices.length === 0) {
                showNotification('No Data', 'No devices to export', 'warning');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Current data
            const currentData = devices.map(d => ({
                'Device Name': d.name,
                'Location': d.location,
                'Status': d.status,
                'AQI': d.data ? d.data.aqi : '--',
                'Temperature': d.data ? d.data.temp : '--',
                'Humidity': d.data ? d.data.humidity : '--',
                'MQ135': d.data ? d.data.ppm_MQ135 : '--',
                'MQ7': d.data ? d.data.ppm_MQ7 : '--',
                'MQ9': d.data ? d.data.ppm_MQ9 : '--',
                'Last Update': d.lastSeen ? new Date(d.lastSeen).toLocaleString('id-ID') : '--'
            }));
            
            const ws = XLSX.utils.json_to_sheet(currentData);
            XLSX.utils.book_append_sheet(wb, ws, 'Current Data');
            
            const filename = `EcoNFC_Data_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Export Success', 'Data exported to Excel', 'success');
        }

        function generateAIReport() {
            const report = {
                timestamp: new Date().toISOString(),
                system: 'EcoNFC AI Air Quality Monitor',
                mqtt_broker: mqttConfig.broker,
                total_devices: devices.length,
                online_devices: devices.filter(d => d.status === 'online').length,
                devices: devices.map(d => ({
                    name: d.name,
                    location: d.location,
                    status: d.status,
                    current_data: d.data,
                    predictions: d.predictions,
                    last_update: d.lastSeen
